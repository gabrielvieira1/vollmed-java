name: 🛡️ Security Analysis Pipeline

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (succeeds even with vulnerabilities)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 1'  # Weekly security scan (Mondays at 2 AM)

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

env:
  # Security scan configuration
  FAIL_ON_CRITICAL: true
  FAIL_ON_HIGH: false
  GENERATE_SARIF: true
  
  # Test Mode Configuration
  # Set to 'true' to run in test mode (workflow succeeds even with vulnerabilities)
  # Set to 'false' or remove to run in production mode (workflow fails with vulnerabilities)
  TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}

jobs:
  security-scan:
    name: 🛡️ Security Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      vulnerabilities-found: ${{ steps.summary.outputs.vulnerabilities-found }}
      critical-count: ${{ steps.summary.outputs.critical-count }}
      high-count: ${{ steps.summary.outputs.high-count }}
    
    steps:
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ☕ Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: 🔍 Initialize Security Summary
        run: |
          echo "# 🛡️ Security Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "📅 **Scan Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "🔗 **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "🌲 **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "💾 **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  gitleaks:
    name: 🔐 GitLeaks - Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: security-scan
    continue-on-error: true
    
    steps:
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Run GitLeaks Scan
        id: gitleaks-scan
        run: |
          echo "🕵️ Executando GitLeaks via Docker (mesmo método do pre-commit)..."
          
          # Criar diretórios necessários
          mkdir -p logs
          
          # Executar GitLeaks via Docker - MESMO COMANDO DO PRE-COMMIT
          docker run --rm \
            -v $(pwd):/path \
            zricethezav/gitleaks:latest \
            detect --source=/path --no-git --verbose --report-format=json --report-path=/path/gitleaks-report.json || echo "GITLEAKS_FAILED=true" >> $GITHUB_ENV
          
          # Também gerar SARIF para compatibilidade com GitHub Security
          if [ -f "gitleaks-report.json" ]; then
            docker run --rm \
              -v $(pwd):/path \
              zricethezav/gitleaks:latest \
              detect --source=/path --no-git --report-format=sarif --report-path=/path/results.sarif || true
          fi
          
          echo "📋 Resultados salvos em gitleaks-report.json e results.sarif"
        continue-on-error: true

      - name: 📋 Generate Human-Readable Report
        if: always()
        run: |
          # Criar relatório legível se houver resultados
          if [ -f "gitleaks-report.json" ]; then
            echo "# 🔍 GitLeaks Detailed Report" > gitleaks-summary.md
            echo "" >> gitleaks-summary.md
            echo "**Scan Date:** $(date)" >> gitleaks-summary.md
            echo "" >> gitleaks-summary.md
            
            # Parse JSON com jq se disponível
            if command -v jq >/dev/null 2>&1; then
              TOTAL_SECRETS=$(jq '. | length' gitleaks-report.json 2>/dev/null || echo "0")
              echo "**Total Secrets Found:** $TOTAL_SECRETS" >> gitleaks-summary.md
              echo "" >> gitleaks-summary.md
              
              if [ "$TOTAL_SECRETS" -gt "0" ]; then
                echo "## 🚨 Detected Secrets:" >> gitleaks-summary.md
                jq -r '.[] | "- **File:** \(.File)\n  - **Line:** \(.StartLine)\n  - **Rule:** \(.RuleID)\n  - **Description:** \(.Description)\n"' gitleaks-report.json >> gitleaks-summary.md
              else
                echo "✅ No secrets detected!" >> gitleaks-summary.md
              fi
            else
              echo "⚠️ jq not available for detailed parsing" >> gitleaks-summary.md
            fi
          else
            echo "# ✅ GitLeaks Report - No Secrets Found" > gitleaks-summary.md
            echo "" >> gitleaks-summary.md
            echo "**Status:** Clean scan - no secrets detected" >> gitleaks-summary.md
          fi

      - name: 📊 GitLeaks Results Summary
        if: always()
        run: |
          # Verificar se GitLeaks encontrou vulnerabilidades (exit code > 0 OU variável GITLEAKS_FAILED)
          if [[ "$GITLEAKS_FAILED" == "true" ]] || [[ "${{ steps.gitleaks-scan.outcome }}" == "failure" ]]; then
            echo "## ❌ GitLeaks - Secret Detection" >> $GITHUB_STEP_SUMMARY
            echo "- 🔴 **Status**: Secrets detected!" >> $GITHUB_STEP_SUMMARY
            echo "- 🔍 **Scan Mode**: Full repository scan (all files)" >> $GITHUB_STEP_SUMMARY
            echo "- ⚠️ **Action Required**: Review and remove exposed secrets" >> $GITHUB_STEP_SUMMARY
            
            # Adicionar detalhes se arquivo JSON existe
            if [ -f "gitleaks-report.json" ] && command -v jq >/dev/null 2>&1; then
              TOTAL_SECRETS=$(jq '. | length' gitleaks-report.json 2>/dev/null || echo "0")
              echo "- 📊 **Secrets Found**: $TOTAL_SECRETS" >> $GITHUB_STEP_SUMMARY
              echo "- 📋 **Details**: Download artifacts for full analysis" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Falhar o job se não estiver em test mode
            if [[ "${{ env.TEST_MODE }}" != "true" ]]; then
              echo "::error title=Secrets Found::GitLeaks detected secrets in the codebase"
              exit 1
            else
              echo "::warning title=Test Mode - Secrets Found::GitLeaks detected secrets but continuing in test mode"
            fi
            fi
            
            echo "- 📖 **Documentation**: [GitLeaks Documentation](https://github.com/gitleaks/gitleaks)" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ✅ GitLeaks - Secret Detection" >> $GITHUB_STEP_SUMMARY
            echo "- 🟢 **Status**: No secrets detected" >> $GITHUB_STEP_SUMMARY
            echo "- 🔍 **Scan Mode**: Full repository scan (all files)" >> $GITHUB_STEP_SUMMARY
            echo "- 📄 **Report**: Check artifacts for detailed results" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: 📤 Upload GitLeaks Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-results
          path: |
            gitleaks-report.json
            gitleaks-summary.md
            results.sarif
          retention-days: 30

  semgrep:
    name: 🧪 Semgrep - SAST Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: security-scan
    continue-on-error: true
    
    container:
      image: semgrep/semgrep
    
    if: (github.actor != 'dependabot[bot]')
    
    env:
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
    
    steps:
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v4

      - name: 🧪 Run Semgrep Analysis
        id: semgrep-scan
        run: |
          # Capturar output completo do semgrep para extrair links
          semgrep ci --json --output=semgrep-results.json 2>&1 | tee semgrep-output.log || echo "SEMGREP_FAILED=true" >> $GITHUB_ENV
          
          # Extrair URLs dos resultados do log
          FINDINGS_URL=""
          SUPPLY_CHAIN_URL=""
          
          if grep -q "View results in Semgrep Cloud Platform:" semgrep-output.log; then
            FINDINGS_URL=$(grep -A2 "View results in Semgrep Cloud Platform:" semgrep-output.log | grep "findings" | xargs || echo "")
            SUPPLY_CHAIN_URL=$(grep -A3 "View results in Semgrep Cloud Platform:" semgrep-output.log | grep "supply-chain" | xargs || echo "")
          fi
          
          # Salvar URLs em variáveis de ambiente
          echo "SEMGREP_FINDINGS_URL=$FINDINGS_URL" >> $GITHUB_ENV
          echo "SEMGREP_SUPPLY_CHAIN_URL=$SUPPLY_CHAIN_URL" >> $GITHUB_ENV
        continue-on-error: true

      - name: 📊 Process Semgrep Results
        if: always()
        run: |
          echo "## 🧪 Semgrep - Static Analysis" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "semgrep-results.json" ]; then
            # Parse results using jq if available, otherwise basic analysis
            if command -v jq >/dev/null 2>&1; then
              TOTAL_ISSUES=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
              CRITICAL_ISSUES=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json 2>/dev/null || echo "0")
              HIGH_ISSUES=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep-results.json 2>/dev/null || echo "0")
              
              echo "- 📊 **Total Issues**: $TOTAL_ISSUES" >> $GITHUB_STEP_SUMMARY
              echo "- 🚨 **Critical/Error**: $CRITICAL_ISSUES" >> $GITHUB_STEP_SUMMARY  
              echo "- 🟡 **Warning**: $HIGH_ISSUES" >> $GITHUB_STEP_SUMMARY
              
              if [ "$TOTAL_ISSUES" -gt "0" ]; then
                echo "- 🔴 **Status**: Vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
                echo "- 📋 **Action**: Review findings in job logs" >> $GITHUB_STEP_SUMMARY
                
                # Falhar o job se não estiver em test mode
                if [[ "${{ env.TEST_MODE }}" != "true" ]]; then
                  echo "::error title=SAST Issues Found::Semgrep detected $TOTAL_ISSUES security issues"
                  exit 1
                else
                  echo "::warning title=Test Mode - SAST Issues Found::Semgrep detected $TOTAL_ISSUES security issues but continuing in test mode"
                fi
              else
                echo "- 🟢 **Status**: No issues found" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- ℹ️ **Status**: Analysis completed (detailed parsing unavailable)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ⚠️ **Status**: Analysis failed or no results file generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Adicionar links dos resultados se disponíveis
          if [ -n "$SEMGREP_FINDINGS_URL" ] || [ -n "$SEMGREP_SUPPLY_CHAIN_URL" ]; then
            echo "- 🔗 **View Results in Semgrep Cloud Platform**:" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "$SEMGREP_FINDINGS_URL" ]; then
              echo "  - 📋 [Code Security Findings]($SEMGREP_FINDINGS_URL)" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -n "$SEMGREP_SUPPLY_CHAIN_URL" ]; then
              echo "  - 📦 [Supply Chain Vulnerabilities]($SEMGREP_SUPPLY_CHAIN_URL)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: 📤 Upload Semgrep Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            semgrep-results.json
            semgrep-output.log
          retention-days: 30

  snyk:
    name: 🐍 Snyk - Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: security-scan
    continue-on-error: true
    
    steps:
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v4

      - name: ☕ Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name:  Build Project
        run: ./mvnw compile -DskipTests

      - name: 🐍 Run Snyk Security Scan
        id: snyk-scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          # Criar diretório de logs
          mkdir -p logs
          
          # Verificar se o token está configurado e executar Snyk via Docker (mesmo container do pre-commit)
          if [ -n "$SNYK_TOKEN" ]; then
            echo "🛡️ Executando Snyk Security Scan via Docker com autenticação..."
            docker run --rm \
              -e SNYK_TOKEN="$SNYK_TOKEN" \
              -v $(pwd):/project \
              -w /project \
              snyk/snyk:java \
              snyk test --package-manager=maven --severity-threshold=medium --json-file-output=snyk-results.json || echo "SNYK_SCAN_FAILED=true" >> $GITHUB_ENV
          else
            echo "⚠️ SNYK_TOKEN não configurado, executando sem autenticação (funcionalidade limitada)..."
            docker run --rm \
              -v $(pwd):/project \
              -w /project \
              snyk/snyk:java \
              snyk test --package-manager=maven --severity-threshold=medium --json-file-output=snyk-results.json || echo "SNYK_SCAN_FAILED=true" >> $GITHUB_ENV
          fi
          
          echo "📋 Resultado do scan disponível em snyk-results.json"
        continue-on-error: true

      - name: 📊 Process Snyk Results  
        if: always()
        run: |
          echo "## 🐍 Snyk - Dependency Analysis" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "snyk-results.json" ]; then
            if command -v jq >/dev/null 2>&1; then
              TOTAL_VULNS=$(jq '.vulnerabilities | length' snyk-results.json 2>/dev/null || echo "0")
              CRITICAL_VULNS=$(jq '[.vulnerabilities[] | select(.severity == "critical")] | length' snyk-results.json 2>/dev/null || echo "0")
              HIGH_VULNS=$(jq '[.vulnerabilities[] | select(.severity == "high")] | length' snyk-results.json 2>/dev/null || echo "0")
              MEDIUM_VULNS=$(jq '[.vulnerabilities[] | select(.severity == "medium")] | length' snyk-results.json 2>/dev/null || echo "0")
              
              echo "- 📊 **Total Vulnerabilities**: $TOTAL_VULNS" >> $GITHUB_STEP_SUMMARY
              echo "- 🚨 **Critical**: $CRITICAL_VULNS" >> $GITHUB_STEP_SUMMARY
              echo "- 🔴 **High**: $HIGH_VULNS" >> $GITHUB_STEP_SUMMARY
              echo "- 🟡 **Medium**: $MEDIUM_VULNS" >> $GITHUB_STEP_SUMMARY
              
              if [ "$CRITICAL_VULNS" -gt "0" ] || [ "$HIGH_VULNS" -gt "0" ]; then
                echo "- 🔴 **Status**: Critical/High vulnerabilities found" >> $GITHUB_STEP_SUMMARY
                echo "- 📋 **Action**: Immediate remediation required" >> $GITHUB_STEP_SUMMARY
                
                # Falhar o job se não estiver em test mode e houver vulnerabilidades críticas/altas
                if [[ "${{ env.TEST_MODE }}" != "true" ]]; then
                  if [ "$CRITICAL_VULNS" -gt "0" ] && [[ "${{ env.FAIL_ON_CRITICAL }}" == "true" ]]; then
                    echo "::error title=Critical Vulnerabilities Found::Snyk detected $CRITICAL_VULNS critical vulnerabilities"
                    exit 1
                  elif [ "$HIGH_VULNS" -gt "0" ] && [[ "${{ env.FAIL_ON_HIGH }}" == "true" ]]; then
                    echo "::error title=High Vulnerabilities Found::Snyk detected $HIGH_VULNS high severity vulnerabilities"
                    exit 1
                  fi
                else
                  echo "::warning title=Test Mode - Vulnerabilities Found::Snyk detected $CRITICAL_VULNS critical and $HIGH_VULNS high vulnerabilities but continuing in test mode"
                fi
              else
                echo "- 🟢 **Status**: No critical/high vulnerabilities" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- ℹ️ **Status**: Analysis completed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            if [ "${{ steps.snyk-scan.outcome }}" = "success" ]; then
              echo "- 🟢 **Status**: No vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ⚠️ **Status**: Analysis failed or vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: 📤 Upload Snyk Results
        if: always() && hashFiles('snyk-results.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: snyk-results
          path: snyk-results.json
          retention-days: 30

  # Final assessment with test mode support
  final-assessment:
    name: 🎯 Final Security Assessment
    needs: [gitleaks, semgrep, snyk]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: 🔍 Evaluate Security Results
        id: evaluation
        run: |
          echo "## 🛡️ Security Assessment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Initialize variables
          VULNERABILITIES_FOUND=false
          CRITICAL_ISSUES=false
          
          # Check each security scan result
          GITLEAKS_STATUS="${{ needs.gitleaks.result }}"
          SEMGREP_STATUS="${{ needs.semgrep.result }}"
          SNYK_STATUS="${{ needs.snyk.result }}"
          
          echo "### 📊 Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "- **GitLeaks**: $GITLEAKS_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- **Semgrep**: $SEMGREP_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- **Snyk**: $SNYK_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine if vulnerabilities were found
          if [[ "$GITLEAKS_STATUS" == "failure" ]] || [[ "$SEMGREP_STATUS" == "failure" ]] || [[ "$SNYK_STATUS" == "failure" ]]; then
            VULNERABILITIES_FOUND=true
          fi
          
          # Check test mode configuration
          if [[ "${{ env.TEST_MODE }}" == "true" ]]; then
            echo "### 🧪 Test Mode Active" >> $GITHUB_STEP_SUMMARY
            echo "- **Mode**: Test Mode (vulnerabilities reported but workflow succeeds)" >> $GITHUB_STEP_SUMMARY
            if [[ "$VULNERABILITIES_FOUND" == "true" ]]; then
              echo "- **Result**: ⚠️ Vulnerabilities found but allowing workflow to succeed in test mode" >> $GITHUB_STEP_SUMMARY
              echo "- **Recommendation**: Review security findings and fix before production deployment" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Result**: ✅ No vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            fi
            echo "::notice title=Test Mode Active::Workflow running in test mode - vulnerabilities will not fail the build"
          else
            echo "### 🏭 Production Mode Active" >> $GITHUB_STEP_SUMMARY
            echo "- **Mode**: Production Mode (vulnerabilities will fail the workflow)" >> $GITHUB_STEP_SUMMARY
            if [[ "$VULNERABILITIES_FOUND" == "true" ]]; then
              echo "- **Result**: ❌ Vulnerabilities found - failing workflow" >> $GITHUB_STEP_SUMMARY
              echo "- **Action**: Fix vulnerabilities before proceeding" >> $GITHUB_STEP_SUMMARY
              echo "::error title=Vulnerabilities Found::Security vulnerabilities detected in production mode"
              exit 1
            else
              echo "- **Result**: ✅ No vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
              echo "- **Status**: Safe to deploy" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Next Steps:" >> $GITHUB_STEP_SUMMARY
          if [[ "$VULNERABILITIES_FOUND" == "true" ]]; then
            echo "1. Review detailed security reports in the job artifacts" >> $GITHUB_STEP_SUMMARY
            echo "2. Fix identified vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run security analysis" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ env.TEST_MODE }}" == "true" ]]; then
              echo "4. When ready for production, disable test mode" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "✅ All security checks passed - no action required" >> $GITHUB_STEP_SUMMARY
          fi
