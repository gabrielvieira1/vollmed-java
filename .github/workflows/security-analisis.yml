name: ğŸ›¡ï¸ Security Analysis Pipeline

on:
  workflow_dispatch:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 1'  # Weekly security scan (Mondays at 2 AM)

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

env:
  # Security scan configuration
  FAIL_ON_CRITICAL: true
  FAIL_ON_HIGH: false
  GENERATE_SARIF: true

jobs:
  security-scan:
    name: ğŸ›¡ï¸ Security Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      vulnerabilities-found: ${{ steps.summary.outputs.vulnerabilities-found }}
      critical-count: ${{ steps.summary.outputs.critical-count }}
      high-count: ${{ steps.summary.outputs.high-count }}
    
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: ğŸ” Initialize Security Summary
        run: |
          echo "# ğŸ›¡ï¸ Security Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“… **Scan Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ² **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¾ **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  gitleaks:
    name: ğŸ” GitLeaks - Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: security-scan
    continue-on-error: true
    
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Run GitLeaks Scan
        id: gitleaks-scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: ğŸ“Š GitLeaks Results Summary
        if: always()
        run: |
          if [ "${{ steps.gitleaks-scan.outcome }}" = "success" ]; then
            echo "## âœ… GitLeaks - Secret Detection" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŸ¢ **Status**: No secrets detected" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ” **Scan Result**: Clean" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ GitLeaks - Secret Detection" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”´ **Status**: Secrets detected!" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸ **Action Required**: Review and remove exposed secrets" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“– **Documentation**: [GitLeaks Documentation](https://github.com/gitleaks/gitleaks)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

  semgrep:
    name: ğŸ§ª Semgrep - SAST Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: security-scan
    continue-on-error: true
    
    container:
      image: semgrep/semgrep
    
    if: (github.actor != 'dependabot[bot]')
    
    env:
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
    
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§ª Run Semgrep Analysis
        id: semgrep-scan
        run: |
          semgrep ci --json --output=semgrep-results.json || echo "SEMGREP_FAILED=true" >> $GITHUB_ENV
        continue-on-error: true

      - name: ğŸ“Š Process Semgrep Results
        if: always()
        run: |
          echo "## ğŸ§ª Semgrep - Static Analysis" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "semgrep-results.json" ]; then
            # Parse results using jq if available, otherwise basic analysis
            if command -v jq >/dev/null 2>&1; then
              TOTAL_ISSUES=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
              CRITICAL_ISSUES=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json 2>/dev/null || echo "0")
              HIGH_ISSUES=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep-results.json 2>/dev/null || echo "0")
              
              echo "- ğŸ“Š **Total Issues**: $TOTAL_ISSUES" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸš¨ **Critical/Error**: $CRITICAL_ISSUES" >> $GITHUB_STEP_SUMMARY  
              echo "- ğŸŸ¡ **Warning**: $HIGH_ISSUES" >> $GITHUB_STEP_SUMMARY
              
              if [ "$TOTAL_ISSUES" -gt "0" ]; then
                echo "- ğŸ”´ **Status**: Vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
                echo "- ğŸ“‹ **Action**: Review findings in job logs" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ğŸŸ¢ **Status**: No issues found" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- â„¹ï¸ **Status**: Analysis completed (detailed parsing unavailable)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- âš ï¸ **Status**: Analysis failed or no results file generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload Semgrep Results
        if: always() && hashFiles('semgrep-results.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 30

  snyk:
    name: ğŸ Snyk - Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: security-scan
    continue-on-error: true
    
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: ğŸ”¨ Build Project
        run: ./mvnw compile -DskipTests

      - name: ğŸ Run Snyk Security Scan
        id: snyk-scan
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --json-file-output=snyk-results.json --severity-threshold=medium
        continue-on-error: true

      - name: ğŸ“Š Process Snyk Results  
        if: always()
        run: |
          echo "## ğŸ Snyk - Dependency Analysis" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "snyk-results.json" ]; then
            if command -v jq >/dev/null 2>&1; then
              TOTAL_VULNS=$(jq '.vulnerabilities | length' snyk-results.json 2>/dev/null || echo "0")
              CRITICAL_VULNS=$(jq '[.vulnerabilities[] | select(.severity == "critical")] | length' snyk-results.json 2>/dev/null || echo "0")
              HIGH_VULNS=$(jq '[.vulnerabilities[] | select(.severity == "high")] | length' snyk-results.json 2>/dev/null || echo "0")
              MEDIUM_VULNS=$(jq '[.vulnerabilities[] | select(.severity == "medium")] | length' snyk-results.json 2>/dev/null || echo "0")
              
              echo "- ğŸ“Š **Total Vulnerabilities**: $TOTAL_VULNS" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸš¨ **Critical**: $CRITICAL_VULNS" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ”´ **High**: $HIGH_VULNS" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸŸ¡ **Medium**: $MEDIUM_VULNS" >> $GITHUB_STEP_SUMMARY
              
              if [ "$CRITICAL_VULNS" -gt "0" ] || [ "$HIGH_VULNS" -gt "0" ]; then
                echo "- ğŸ”´ **Status**: Critical/High vulnerabilities found" >> $GITHUB_STEP_SUMMARY
                echo "- ğŸ“‹ **Action**: Immediate remediation required" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ğŸŸ¢ **Status**: No critical/high vulnerabilities" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- â„¹ï¸ **Status**: Analysis completed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            if [ "${{ steps.snyk-scan.outcome }}" = "success" ]; then
              echo "- ğŸŸ¢ **Status**: No vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âš ï¸ **Status**: Analysis failed or vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload Snyk Results
        if: always() && hashFiles('snyk-results.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: snyk-results
          path: snyk-results.json
          retention-days: 30

  security-summary:
    name: ğŸ“‹ Security Summary & Notification
    runs-on: ubuntu-latest
    needs: [gitleaks, semgrep, snyk, dependency-check]
    if: always()
    
    steps:
      - name: ğŸ”„ Checkout Repository  
        uses: actions/checkout@v4

      - name: ğŸ“‹ Generate Final Security Summary
        run: |
          echo "## ğŸ¯ Overall Security Assessment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          OVERALL_STATUS="ğŸŸ¢ PASSED"
          CRITICAL_ISSUES=false
          
          # Check job outcomes
          if [[ "${{ needs.gitleaks.result }}" == "failure" ]]; then
            echo "- âŒ **GitLeaks**: Secrets detected" >> $GITHUB_STEP_SUMMARY
            CRITICAL_ISSUES=true
            OVERALL_STATUS="ğŸ”´ FAILED"
          else
            echo "- âœ… **GitLeaks**: No secrets found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.semgrep.result }}" == "failure" ]]; then
            echo "- âš ï¸ **Semgrep**: Issues detected (check logs)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **Semgrep**: Analysis completed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.snyk.result }}" == "failure" ]]; then
            echo "- âš ï¸ **Snyk**: Vulnerabilities detected (check logs)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **Snyk**: Analysis completed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.dependency-check.result }}" == "failure" ]]; then
            echo "- âŒ **OWASP Dependency Check**: Critical/High vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            CRITICAL_ISSUES=true
            OVERALL_STATUS="ğŸ”´ FAILED"
          else
            echo "- âœ… **OWASP Dependency Check**: Analysis completed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### $OVERALL_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CRITICAL_ISSUES" = true ]; then
            echo "ğŸš¨ **Critical security issues detected!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Immediate Actions Required:**" >> $GITHUB_STEP_SUMMARY
            echo "1. ğŸ” Review all failed security checks above" >> $GITHUB_STEP_SUMMARY
            echo "2. ğŸ“¥ Download artifact reports for detailed analysis" >> $GITHUB_STEP_SUMMARY
            echo "3. ğŸ› ï¸ Fix critical and high-severity issues" >> $GITHUB_STEP_SUMMARY
            echo "4. ğŸ”„ Re-run security pipeline after fixes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“– **Documentation**: [Security Best Practices](https://github.com/${{ github.repository }}/blob/main/README.md#vulnerabilidades-educacionais-intencionais)" >> $GITHUB_STEP_SUMMARY
            
            # Set job outcome
            echo "SECURITY_FAILED=true" >> $GITHUB_ENV
            exit 1
          else
            echo "âœ… **All security checks passed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your code meets the security requirements. Great job! ğŸ‰" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request' && env.SECURITY_FAILED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ›¡ï¸ Security Analysis Results
              
              âŒ **Security vulnerabilities detected in this PR**
              
              Please check the [Security Analysis workflow results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed information.
              
              ğŸ”§ **Action Required**: Fix security issues before merging.
              ğŸ“Š **Reports**: Download artifacts from the workflow run for detailed analysis.`
            })